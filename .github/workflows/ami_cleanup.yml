name: AMI Cleanup

on:
  workflow_dispatch:
    inputs:
      application:
        description: 'Application folder name (e.g. nomis)'
        required: true
        type: string
      environments:
        description: 'Comma-separated list of environments (e.g. development,production)'
        required: true
        type: string
      ami_cleanup_sh_args:
        description: 'Arguments passed to ami_cleanup.sh (e.g. -c -m 3)'
        required: false
        default: "-c -m 3"
        type: string
      dryrun:
        description: 'Dry run mode for AMI cleanup'
        required: true
        default: true
        type: boolean

  workflow_call:
    inputs:
      application:
        required: true
        type: string
      environments:
        required: true
        type: string
      ami_cleanup_sh_args:
        required: false
        type: string
      dryrun:
        required: false
        type: boolean

permissions:
  id-token: write
  contents: read

jobs:
  build-matrix:
    name: Build Account Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.strategy.outputs.matrix }}
    steps:
      - name: Build strategy matrix from application + environments
        id: strategy
        run: |
          app="${{ github.event.inputs.application || inputs.application }}"
          envs_str="${{ github.event.inputs.environments || inputs.environments }}"

          IFS=', ' read -r -a envs <<< "$envs_str"

          echo "Application: $app"
          echo "Environments: ${envs[@]}"

          echo '{"include":[' > matrix.json
          for env in "${envs[@]}"; do
            acc="${app}-${env}"
            echo "Adding account: $acc"
            echo "{\"account_name\":\"$acc\"}," >> matrix.json
          done
          sed -i '$ s/,$//' matrix.json
          echo ']}' >> matrix.json

          matrix=$(cat matrix.json)
          echo 'matrix<<EOF' >> $GITHUB_OUTPUT
          echo "${matrix}" >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT

  check-amis:
    name: Identify Unused AMIs
    runs-on: ubuntu-latest
    needs: build-matrix
    strategy:
      matrix: ${{ fromJson(needs.build-matrix.outputs.matrix) }}
      max-parallel: 1
    steps:
      - name: Get Account Details
        id: account
        run: |
          echo "Account: ${{ matrix.account_name }}"
          account_id="${{ fromJSON(secrets.MODERNISATION_PLATFORM_ENVIRONMENT_MANAGEMENT).account_ids[matrix.account_name] }}"
          role_arn="arn:aws:iam::${account_id}:role/modernisation-platform-oidc-cicd"
          echo "role_arn=${role_arn}" >> $GITHUB_OUTPUT

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502 # v4.0.2
        with:
          role-to-assume: "${{ steps.account.outputs.role_arn }}"
          role-session-name: "github-${{ github.repository_id }}-${{ github.run_id }}-${{ matrix.account_name }}"
          aws-region: eu-west-2

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Run AMI Cleanup Script (collect commands)
        id: ami-check
        run: |
          app="${{ github.event.inputs.application || inputs.application }}"
          args="${{ github.event.inputs.ami_cleanup_sh_args || inputs.ami_cleanup_sh_args }}"
          echo "Running AMI cleanup for ${{ matrix.account_name }} with args: $args"
          src/ami_cleanup.sh -a "$app" -s aws_cli_commands.sh $args delete
          if [[ -s aws_cli_commands.sh ]]; then
            echo "cleanup=1" >> $GITHUB_OUTPUT
          else
            echo "cleanup=0" >> $GITHUB_OUTPUT

      - name: Upload AMI Commands Artifact
        if: ${{ steps.ami-check.outputs.cleanup == 1 }}
        uses: actions/upload-artifact@v4
        with:
          name: "aws_cli_commands.sh"
          path: aws_cli_commands.sh
          overwrite: true

  cleanup-amis:
    name: Cleanup AMIs
    runs-on: ubuntu-latest
    needs: [build-matrix, check-amis]
    if: ${{ github.event.inputs.dryrun == 'false' || inputs.dryrun == false }}
    strategy:
      matrix: ${{ fromJson(needs.build-matrix.outputs.matrix) }}
      max-parallel: 1
    steps:
      - name: Get Account Details
        id: account
        run: |
          echo "Account: ${{ matrix.account_name }}"
          account_id="${{ fromJSON(secrets.MODERNISATION_PLATFORM_ENVIRONMENT_MANAGEMENT).account_ids[matrix.account_name] }}"
          role_arn="arn:aws:iam::${account_id}:role/modernisation-platform-oidc-cicd"
          echo "role_arn=${role_arn}" >> $GITHUB_OUTPUT

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@e3dd6a429d7300a6a4c196c26e071d42e0343502 # v4.0.2
        with:
          role-to-assume: "${{ steps.account.outputs.role_arn }}"
          role-session-name: "github-${{ github.repository_id }}-${{ github.run_id }}-${{ matrix.account_name }}"
          aws-region: eu-west-2

      - name: Download AMI Commands Artifact
        uses: actions/download-artifact@v5
        with:
          name: "aws_cli_commands.sh"

      - name: Execute AMI Deregistration Commands
        run: |
          IFS=$'\n'
          cmds=($(sed -n '/aws ec2 deregister-image/p' aws_cli_commands.sh))
          unset IFS
          n=${#cmds[@]}
          echo "Executing $n AMI deregistration commands for ${{ matrix.account_name }}"
          for ((i=0;i<n;i++)); do
            echo "[$((i+1))/$n]: ${cmds[$i]}"
            ${cmds[$i]}
          done
